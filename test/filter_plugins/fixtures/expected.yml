---
haproxy_defaults:
  - errorfile 400 /etc/haproxy/errors/400.http
  - errorfile 403 /etc/haproxy/errors/403.http
  - errorfile 408 /etc/haproxy/errors/408.http
  - errorfile 500 /etc/haproxy/errors/500.http
  - errorfile 502 /etc/haproxy/errors/502.http
  - errorfile 503 /etc/haproxy/errors/503.http
  - errorfile 504 /etc/haproxy/errors/504.http
  - log global
  - mode http
  # Preserve order within YAML sequences.
  - option httplog
  - option dontlognull
  - timeout client 50000
  - timeout connect 5000
  - timeout server 50000

haproxy_global:
  - ca-base /etc/ssl/certs
  - chroot /var/lib/haproxy
  - crt-base /etc/ssl/private
  - daemon
  - group haproxy
  - log /dev/log local0
  - log /dev/log local1 notice
  - ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS
  - ssl-default-bind-options no-sslv3
  - stats socket /run/haproxy/admin.sock mode 660 level admin
  - stats timeout 30s
  - user haproxy

haproxy_mailers:
  mailers1:
    - mailer smtp1 192.0.2.1:587
    - mailer smtp2 192.0.2.2:587
  mailers2:
    - mailer smtp1 192.51.100.1:587
    - mailer smtp2 192.51.100.2:587

haproxy_peers:
  peers1:
    - peer haproxy1 192.0.2.1:1024
    - peer haproxy2 192.0.2.2:1024
    - peer haproxy3 192.0.2.3:1024
  peers2:
    - peer haproxy1 192.51.100.1:1024
    - peer haproxy2 192.51.100.2:1024
    - peer haproxy3 192.51.100.3:1024

haproxy_resolvers:
  resolvers1:
    - hold valid 10s
    - nameserver dns1 192.0.2.1:53
    - nameserver dns2 192.0.2.2:53
    - resolve_retries 3
    - timeout retry 1s
  resolvers2:
    - hold valid 10s
    - nameserver dns1 192.51.100.1:53
    - nameserver dns2 192.51.100.2:53
    - resolve_retries 3
    - timeout retry 1s

haproxy_userlists:
  userlist1:
    - group G1 users tiger,scott
    - group G2 users xdb,scott
    - user tiger password $6$k6y3o.eP$JlKBx9za9667qe4(...)xHSwRv6J.C0/D7cV91
    - user scott insecure-password elgato
    - user xdb insecure-password hello
  userlist2:
    - group G1
    - group G2
    - user tiger password $6$k6y3o.eP$JlKBx(...)xHSwRv6J.C0/D7cV91 groups G1
    - user scott insecure-password elgato groups G1,G2
    - user xdb insecure-password hello groups G2

haproxy_listens:
  listen1:
    # rank -1
    - acl invalid_src src 0.0.0.0/7 224.0.0.0/3
    - acl invalid_src src_port 0:1023
    - acl local_dst hdr(host) -i localhost
    - acl es req.fhdr(accept-language),language(es;fr;en) -m str es
    - acl fr req.fhdr(accept-language),language(es;fr;en) -m str fr
    - acl en req.fhdr(accept-language),language(es;fr;en) -m str en
    # rank 0, in alphabetical order
    - bind :80
    - bind :443 ssl crt /etc/haproxy/site.pem
    - mode http
    # rank 2
    - tcp-request connection accept if { src -f /etc/haproxy/whitelist.lst }
    - tcp-request connection reject if { src_conn_rate gt 10 }
    - tcp-request connection track-sc0 src
    # rank 3
    - block if invalid_src || local_dst
    # rank 4
    - http-request deny if invalid_src || local_dst
    # rank 5, in order
    - reqdel ^X-Forwarded-For:.*
    - reqdel ^Cookie:.*SERVER=
    - reqpass ^Host:\ www.private\.local
    # rank 6
    - reqadd X-Proto:\ SSL if is-ssl
    # rank 7
    - redirect prefix https://mysite.com set-cookie SEEN=1 if !cookie_set
    - redirect prefix https://mysite.com if login_page !secure
    - redirect prefix http://mysite.com drop-query if login_page !uid_given
    - redirect location http://mysite.com/ if !login_page secure
    - redirect location / clear-cookie USERID= if logout
    # rank 8
    - use_backend backend1 if is-app1
    - use_backend backend2 if is-app2
    # rank 9
    - use-server www if { req_ssl_sni -i www.example.com }
    - use-server mail if { req_ssl_sni -i mail.example.com }
    - use-server imap if { req_ssl_sni -i imap.example.com }
    # rank 100
    - server default 192.0.2.2:443 check
    - server imap 192.0.2.1:993 weight 0
    - server mail 192.0.2.1:587 weight 0
    - server www 192.0.2.1:443 weight 0
  listen2:
    - no log
